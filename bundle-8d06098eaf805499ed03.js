(()=>{"use strict";class t{color;name;me=!1;constructor(t,e,s=!1){this.name=t,this.color=e,this.me=s}}var e,s;!function(t){t.WHITE="white",t.BLACK="black"}(e||(e={})),function(t){t.BISHOP="Bishop",t.KING="King",t.KNIGHT="Knight",t.PAWN="Pawn",t.QUEEN="Queen",t.ROOK="Rook"}(s||(s={}));class i{moves=[];add(t){this.moves.push(t)}getMoves(){return this.moves.map((t=>`${t.player.name}: ${t.figure.figure} ${t.from.coordinates} - ${t.to.coordinates}`))}}class o{player;figure;from;to;timestamp;constructor(t,e,s){this.player=t,this.figure=e.figure,this.from=e,this.to=s,this.timestamp=Date.now(),this.figure.isMoved=!0,s.figure=e.figure,e.figure=null}}const r="#352e31",a="#51464a",h="#EED6D3",l="#cebab7",n="#3a3234",c="#2e9a0d",g="#a11a39",u=32,m=400;class d{static circle(t,e,s,i,o={}){t.beginPath(),t.arc(e,s,i,0,2*Math.PI),d.draw(t,o)}static rect(t,e,s,i,o,r={}){t.beginPath(),t.rect(e,s,i,o),d.draw(t,r)}static roundedRect(t,e,s,i,o,r,a={}){t.beginPath(),t.moveTo(e+r,s),t.lineTo(e+i-r,s),t.quadraticCurveTo(e+i,s,e+i,s+r),t.lineTo(e+i,s+o-r),t.quadraticCurveTo(e+i,s+o,e+i-r,s+o),t.lineTo(e+r,s+o),t.quadraticCurveTo(e,s+o,e,s+o-r),t.lineTo(e,s+r),t.quadraticCurveTo(e,s,e+r,s),t.closePath(),d.draw(t,a)}static text(t,e,s,i,o={}){o.line_width&&(t.lineWidth=2),o.text_align&&(t.textAlign=o.text_align),o.text_valign&&(t.textBaseline=o.text_valign),o.font&&(t.font=o.font),o.line_color&&(t.strokeStyle=o.line_color),t.strokeText(e,s,i),d.reset(t)}static preloadedImage(t,e,s,i,o,r,a={}){a.shadow_blur&&(t.shadowBlur=a.shadow_blur,a.shadow_color&&(t.shadowColor=a.shadow_color)),t.drawImage(r,e,s,i,o),d.reset(t)}static image(t,e,s,i,o,r,a={},h=(()=>null)){const l=new Image(i,o);a.shadow_blur&&(t.shadowBlur=a.shadow_blur,a.shadow_color&&(t.shadowColor=a.shadow_color)),l.onload=()=>{t.drawImage(l,e,s,i,o),d.reset(t),h()},l.src=r}static draw(t,e={}){e.line_width&&(t.lineWidth=e.line_width),e.stroke&&(e.line_color&&(t.strokeStyle=e.line_color),t.stroke()),e.fill&&(e.fill_color&&(t.fillStyle=e.fill_color),t.fill()),e.shadow_blur&&(t.shadowBlur=20,e.shadow_color&&(t.shadowColor=e.shadow_color)),d.reset(t)}static reset(t){t.shadowBlur=0,t.shadowColor="transparent",t.strokeStyle="black",t.fillStyle="black",t.lineWidth=1}}class w{static boardSize(){let t=Math.max(m,Math.min(window.innerWidth,window.innerHeight));return t-=t/10,t%8!=0&&(t=8*Math.floor(t/8)),t}static cellSize(){return(w.boardSize()-2*u)/8-2.3}static rowToLetter(t){return String.fromCharCode(64+t)}}class f{game;context;size;color;image;row;column;state={has_figure:!0,is_highlighted:!1,is_active:!1,is_movable:!1,has_moves:!1,move_figure:null};prevState;constructor(t,e,s,i){this.color=this.getColorByRowAndColumn(t,e),this.row=t,this.column=e,this.size=w.cellSize(),this.context=s,this.game=i,this.image=new Image(this.size,this.size),this.image.src=`assets/images/cell_bg_${Math.floor(8*Math.random())+1}.png`}_figure;get figure(){return this._figure}set figure(t){this._figure=t,this.state.has_figure=!!t}get x(){return this.size*this.column+2*this.column+2+u}get y(){return this.size*Math.abs(this.row-7)+2*Math.abs(this.row-7)+2+u}get cellColor(){return this.state.is_active?c:this.state.is_highlighted?this.color===e.BLACK?a:l:this.color===e.BLACK?r:h}get coordinates(){return`${this.rowToLetter}${this.column+1}`}get rowToLetter(){return String.fromCharCode(65+this.row)}getColorByRowAndColumn(t,s){return(t+1)%2&&(s+1)%2||!((t+1)%2||(s+1)%2)?e.BLACK:e.WHITE}render(t=!1){!t&&this.prevState&&JSON.stringify(this.state)===JSON.stringify(this.prevState)||(this.prevState={...this.state},d.rect(this.context,this.x,this.y,this.size,this.size,{fill:!0,fill_color:this.cellColor,stroke:!0,line_color:n,line_width:2}),d.preloadedImage(this.context,this.x,this.y,this.size,this.size,this.image),this.figure?.image&&(d.preloadedImage(this.context,this.x,this.y,this.size,this.size,this.figure.image),this.state.is_movable&&(d.circle(this.context,this.x+this.size/2,this.y+this.size/2,this.size/4,{fill:!0,fill_color:g}),this.state.move_figure&&d.preloadedImage(this.context,this.x+this.size/3,this.y+this.size/3,this.size/3,this.size/3,this.state.move_figure))),this.state.is_movable&&!this.figure&&(d.circle(this.context,this.x+this.size/2,this.y+this.size/2,this.size/4,{fill:!0,fill_color:c}),this.state.move_figure&&d.preloadedImage(this.context,this.x+this.size/3,this.y+this.size/3,this.size/3,this.size/3,this.state.move_figure)),!this.game.isAuto&&this.game.me.color===this.game.activePlayer.color&&this.state.has_moves&&d.rect(this.context,this.x,this.y+this.size-this.size/20,this.size,this.size/20,{fill:!0,fill_color:c}))}}class v{color;multiplier=1;figure;image;moves=[];isMoved=!1;constructor(t){this.color=t,this.multiplier=t===e.WHITE?1:-1}setFigure(t){this.figure=t,this.image=new Image(w.cellSize(),w.cellSize()),this.image.src=`assets/icons/figures/${this.color}/${this.figure.toLowerCase()}.svg`}getMoves(t,e){return this.moves.filter((s=>s.isValid(t,e)))}hasMoves(t,e){return!!this.getMoves(t,e).length}showMoves(t,e){this.getMoves(t,e).forEach((s=>{const i=t.board.getCell(e.row+s.row,e.column+s.column);i&&(i.state.is_movable=!0,i.state.move_figure=e?.figure?.image??null)}))}}class p extends v{constructor(t){super(t),this.setFigure(s.KING),this.moves=[new y(1,1),new y(1,0),new y(1,-1),new y(0,1),new y(0,-1),new y(-1,1),new y(-1,0),new y(-1,-1)]}}class y{multiplier=1;row;column;conditions=[];conditionCallbacks={isBlack:(t,s)=>s?.figure?.color===e.BLACK,isWhite:(t,s)=>s?.figure?.color===e.WHITE,isNotOwn:(t,e)=>!this.getTarget(t,e)?.figure||!t.isOwn(t.activePlayer,this.getTarget(t,e)?.figure),isEnemy:(t,e)=>!!this.getTarget(t,e)?.figure&&!t.isOwn(t.activePlayer,this.getTarget(t,e)?.figure),isEmpty:(t,e)=>!this.getTarget(t,e)?.figure,isNotEmpty:(t,e)=>!!this.getTarget(t,e)?.figure,isMoved:(t,e)=>!!e?.figure?.isMoved,isNotMoved:(t,e)=>!e?.figure?.isMoved,isCellExists:(t,e)=>!!this.getTarget(t,e),isVerticalPathEmpty:(t,e)=>Array(Math.abs(this.row)-1).fill(0).every(((s,i)=>!t.board.getCell(e.row+(i+1)*(this.row>0?1:-1),e.column)?.figure)),isHorizontalPathEmpty:(t,e)=>Array(Math.abs(this.column)-1).fill(0).every(((s,i)=>!t.board.getCell(e.row,e.column+(i+1)*(this.column>0?1:-1))?.figure)),isDiagonalPathEmpty:(t,e)=>Array(Math.abs(this.row)-1).fill(0).every(((s,i)=>!t.board.getCell(e.row+(i+1)*(this.row>0?1:-1),e.column+(i+1)*(this.column>0?1:-1))?.figure)),isNotKing:(t,e)=>!(this.getTarget(t,e)?.figure instanceof p)};constructor(t,e,s=[],i=!0){this.row=t,this.column=e,this.conditions=s,i&&(this.conditions.includes("isCellExists")||this.conditions.push("isCellExists"),this.conditions.includes("isNotOwn")||this.conditions.push("isNotOwn"),this.conditions.includes("isNotKing")||this.conditions.push("isNotKing"))}getTarget(t,e){return t.board.getCell(e.row+this.row,e.column+this.column)}isValid(t,e){return this.conditions.every((s=>this.conditionCallbacks[s](t,e)))}}class _ extends v{constructor(t){super(t),this.setFigure(s.PAWN),this.moves=[new y(2,0,["isNotMoved","isVerticalPathEmpty","isEmpty","isWhite"]),new y(1,0,["isEmpty","isWhite"]),new y(1,-1,["isEnemy","isWhite"]),new y(1,1,["isEnemy","isWhite"]),new y(-2,0,["isNotMoved","isVerticalPathEmpty","isEmpty","isBlack"]),new y(-1,0,["isEmpty","isBlack"]),new y(-1,-1,["isEnemy","isBlack"]),new y(-1,1,["isEnemy","isBlack"])]}}class E extends v{constructor(t){super(t),this.setFigure(s.ROOK);for(let t=1;t<8;t++)this.moves.push(new y(t,0,["isVerticalPathEmpty"])),this.moves.push(new y(-t,0,["isVerticalPathEmpty"])),this.moves.push(new y(0,t,["isHorizontalPathEmpty"])),this.moves.push(new y(0,-t,["isHorizontalPathEmpty"]))}}class z extends v{constructor(t){super(t),this.setFigure(s.KNIGHT),this.moves=[new y(2,1,["isNotOwn"]),new y(2,-1,["isNotOwn"]),new y(-2,1,["isNotOwn"]),new y(-2,-1,["isNotOwn"]),new y(1,2,["isNotOwn"]),new y(1,-2,["isNotOwn"]),new y(-1,2,["isNotOwn"]),new y(-1,-2,["isNotOwn"])]}}class C extends v{constructor(t){super(t),this.setFigure(s.BISHOP);for(let t=1;t<8;t++)this.moves.push(new y(t,t,["isDiagonalPathEmpty"])),this.moves.push(new y(t,-t,["isDiagonalPathEmpty"])),this.moves.push(new y(-t,t,["isDiagonalPathEmpty"])),this.moves.push(new y(-t,-t,["isDiagonalPathEmpty"]))}}class b extends v{constructor(t){super(t),this.setFigure(s.QUEEN);for(let t=1;t<8;t++)this.moves.push(new y(t,t,["isDiagonalPathEmpty"])),this.moves.push(new y(t,-t,["isDiagonalPathEmpty"])),this.moves.push(new y(-t,t,["isDiagonalPathEmpty"])),this.moves.push(new y(-t,-t,["isDiagonalPathEmpty"])),this.moves.push(new y(t,0,["isVerticalPathEmpty"])),this.moves.push(new y(-t,0,["isVerticalPathEmpty"])),this.moves.push(new y(0,t,["isHorizontalPathEmpty"])),this.moves.push(new y(0,-t,["isHorizontalPathEmpty"]))}}class x{game;canvas;context;size;cells=[];state;prevState;constructor(t){this.game=t,this.canvas=document.querySelector("canvas.board"),this.context=this.canvas.getContext("2d");for(let e=0;e<8;e++)for(let s=0;s<8;s++)this.cells.push(new f(e,s,this.context,t))}setBoardSize(){this.size!==w.boardSize()&&(this.size=w.boardSize(),this.cells.forEach((t=>t.size=w.cellSize())),this.canvas&&(this.canvas.width=this.size,this.canvas.height=this.size))}getCell(t,e){return this.cells.find((s=>s.row===t&&s.column===e))}getCellByXAndY(t,e){return this.cells.find((s=>t>=s.x&&t<=s.x+s.size&&e>=s.y&&e<=s.y+s.size))}reset(){this.setBoardSize(),this.cells.forEach((t=>t.figure=null)),[0,7].forEach((t=>{const s=t?e.BLACK:e.WHITE;this.getCell(t,0).figure=new E(s),this.getCell(t,1).figure=new z(s),this.getCell(t,2).figure=new C(s),this.getCell(t,3).figure=new b(s),this.getCell(t,4).figure=new p(s),this.getCell(t,5).figure=new C(s),this.getCell(t,6).figure=new z(s),this.getCell(t,7).figure=new E(s)})),[1,6].forEach((t=>{for(let s=0;s<8;s++)this.getCell(t,s).figure=new _(1===t?e.WHITE:e.BLACK)})),requestAnimationFrame((()=>this.render()))}render(t=!1){if(this.state=this.getState(),t||!this.prevState||JSON.stringify(this.state)!==JSON.stringify(this.prevState)){this.prevState={...this.state},d.rect(this.context,1,1,this.size-2,this.size-2,{stroke:!0,line_color:n,line_width:2,fill:!0,fill_color:r});const t=this.cells[0].size,e={line_width:2,text_align:"center",text_valign:"middle",font:"18px Arial",line_color:h};for(let s=1;s<=8;s++)d.text(this.context,s.toString(),(s-1)*t+t/2+u+2.3*(s-1)+3,u/2+2,e),d.text(this.context,s.toString(),(s-1)*t+t/2+u+2.3*(s-1)+3,this.size-u/2-2,e),d.text(this.context,String.fromCharCode(64+s),u/2,Math.abs(s-8)*t+t/2+u+2.6*Math.abs(s-8),e),d.text(this.context,String.fromCharCode(64+s),this.size-u/2,Math.abs(s-8)*t+t/2+u+2.6*Math.abs(s-8),e);this.cells.forEach((t=>t.render(!0)))}this.cells.forEach((t=>{t.state.has_moves=this.game.activePlayer.color===t.figure?.color&&t?.figure?.hasMoves(this.game,t),t.render(!0)})),requestAnimationFrame((()=>this.render()))}getState(){return{size:w.boardSize()}}}class M{board;isAuto=!1;log=new i;players=[];activePlayer;constructor(){this.players.push(new t("Sergey",e.WHITE,!0)),this.players.push(new t("Vet",e.BLACK)),this.changePlayer(),this.activePlayer.color!==this.me.color&&setTimeout((()=>this.autoMove()),100),this.board=new x(this),this.board.reset()}get me(){return this.players.find((t=>t.me))}get activeCell(){return this.board.cells.find((t=>t.state.is_active))??null}move(t,e,s){const i=new o(t,e,s);this.log.add(i),this.changePlayer(),this.board.cells.forEach((t=>t.state.is_movable=!1)),this.isAuto||this.activePlayer.color===this.me.color||setTimeout((()=>this.autoMove()),100)}changePlayer(){this.activePlayer=this.activePlayer===this.players[0]?this.players[1]:this.players[0]}isOwn(t,e){return e.color===t.color}onClick(t){const e=this.board.getCellByXAndY(t.offsetX,t.offsetY);e?.state.is_movable&&this.activeCell&&this.move(this.activePlayer,this.activeCell,e),this.board.cells.forEach((t=>t.state.is_movable=!1)),e?.state.is_active?e.state.is_active=!1:(this.board.cells.forEach((t=>t.state.is_active=!1)),e?.figure&&e?.state.has_moves&&(e.state.is_active=!0,e.figure.showMoves(this,e)))}onMouseLeave(){this.board.cells.forEach((t=>t.state.is_highlighted=!1))}onMouseMove(t){this.board.cells.forEach((t=>t.state.is_highlighted=!1));const e=this.board.getCellByXAndY(t.offsetX,t.offsetY);return(e?.state.has_moves||e?.state.is_movable)&&(e.state.is_highlighted=!0),!!e?.state.is_highlighted}autoMove(){const t=this.board.cells.filter((t=>t.state.has_moves&&t.state.has_figure));if(t.length){const e=t[Math.floor(Math.random()*t.length)];e.state.is_active=!0,e.figure?.showMoves(this,e);const s=this.board.cells.filter((t=>t.state.is_movable));if(s.length){const t=s[Math.floor(Math.random()*s.length)];this.move(this.activePlayer,e,t),e.state.is_active=!1}}}autoGame(){this.isAuto=!0,setInterval((()=>this.autoMove()),100)}}document.addEventListener("DOMContentLoaded",(()=>{const t=document.querySelector(".board"),e=new M;document.addEventListener("click",(t=>e.onClick(t))),window.addEventListener("resize",(()=>e.board.setBoardSize())),t&&(t.addEventListener("mousemove",(s=>{e.onMouseMove(s)?t.classList.add("pointer"):t.classList.remove("pointer")})),t.addEventListener("mouseout",(()=>e.onMouseLeave())))}))})();